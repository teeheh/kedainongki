// Apps Script entry
function doGet(e) {
    // Jika ada parameter action, handle sebagai API call
    if (e.parameter.action) {
        const result = handleRequest(e.parameter);
        return ContentService.createTextOutput(JSON.stringify(result))
            .setMimeType(ContentService.MimeType.JSON)
            .addHeader('Access-Control-Allow-Origin', '*');
    }
    
    // Jika tidak ada action, return HTML page
    return HtmlService.createTemplateFromFile('index').evaluate()
        .setTitle("Kas Kedai Nongki")
        .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// Handle OPTIONS requests for CORS preflight
function doOptions(e) {
    return ContentService.createTextOutput('')
        .setMimeType(ContentService.MimeType.TEXT)
        .addHeader('Access-Control-Allow-Origin', '*')
        .addHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
        .addHeader('Access-Control-Allow-Headers', 'Content-Type')
        .addHeader('Access-Control-Max-Age', '3600');
}

function doPost(e) {
    try {
        // Process the POST request
        if (e.postData.type === "application/json") {
            const data = JSON.parse(e.postData.contents);
            const result = handleRequest(data);
            return ContentService.createTextOutput(JSON.stringify(result))
                .setMimeType(ContentService.MimeType.JSON)
                .addHeader('Access-Control-Allow-Origin', '*');
        } else {
            const result = {success: false, error: "Invalid content type"};
            return ContentService.createTextOutput(JSON.stringify(result))
                .setMimeType(ContentService.MimeType.JSON)
                .addHeader('Access-Control-Allow-Origin', '*');
        }
    } catch (error) {
        const result = {success: false, error: error.toString()};
        return ContentService.createTextOutput(JSON.stringify(result))
            .setMimeType(ContentService.MimeType.JSON)
            .addHeader('Access-Control-Allow-Origin', '*');
    }
}

function handleRequest(params) {
    try {
        let result = {};
        
        switch (params.action) {
            case 'getDashboard':
                result = getDashboard();
                break;
            case 'getDashboardRange':
                result = getDashboardRange(params.start, params.end);
                break;
            case 'getTransaksi':
                result = getTransaksi();
                break;
            case 'getLast10Transaksi':
                result = getLast10Transaksi();
                break;
            case 'addTransaksi':
                addTransaksi(params);
                result = {success: true};
                break;
            case 'editTransaksi':
                editTransaksi(params);
                result = {success: true};
                break;
            case 'deleteTransaksi':
                deleteTransaksi(params.index);
                result = {success: true};
                break;
            case 'getProduk':
                result = getProduk();
                break;
            case 'addProduk':
                addProduk(params.id, params.nama, params.harga);
                result = {success: true};
                break;
            case 'getStok':
                result = getStok();
                break;
            case 'addStok':
                addStok(params.id, params.jumlah);
                result = {success: true};
                break;
            case 'getLaporan':
                result = getLaporan(params.start, params.end);
                break;
            case 'exportLaporanPDF':
                result = exportLaporanPDF(params.start, params.end);
                break;
            case 'exportLaporanPDFInline':
                result = exportLaporanPDFInline(params.start, params.end);
                break;
            case 'exportLaporanExcel':
                result = exportLaporanExcel(params.start, params.end);
                break;
            default:
                result = {success: false, error: 'Unknown action: ' + params.action};
        }
        
        return ContentService.createTextOutput(JSON.stringify(result))
            .setMimeType(ContentService.MimeType.JSON);
            
    } catch (error) {
        return ContentService.createTextOutput(JSON.stringify({success: false, error: error.toString()}))
            .setMimeType(ContentService.MimeType.JSON);
    }
}

function include(filename) {
    return HtmlService.createHtmlOutputFromFile(filename).getContent();
}



// === KONFIGURASI SHEET ===
const SHEETS = {
    transaksi: {
        name: "Transaksi",
        headers: ["Tanggal", "Keterangan", "Kategori", "Tunai", "Non Tunai"]
    },
    produk: {
        name: "Produk",
        headers: ["ID", "Nama", "Harga"]
    },
    stok: {
        name: "Stok",
        headers: ["ID Produk", "Jumlah"]
    }
};

// Buat sheet jika belum ada + set header
function initSheet(type) {
    try {
        const cfg = SHEETS[type];
        const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
        let sheet = spreadsheet.getSheetByName(cfg.name);
        
        if (!sheet) {
            sheet = spreadsheet.insertSheet(cfg.name);
            sheet.appendRow(cfg.headers);
        } else {
            const firstRow = sheet.getRange(1, 1, 1, cfg.headers.length).getValues()[0];
            if (firstRow.join("") === "") {
                sheet.getRange(1, 1, 1, cfg.headers.length).setValues([cfg.headers]);
            }
        }
        return sheet;
    } catch (error) {
        console.error("Error in initSheet:", error);
        throw error;
    }
}

// === DASHBOARD ===
function getDashboard() {
    const sheet = initSheet("transaksi");
    const data = sheet.getDataRange().getValues();
    let tunai = 0, nonTunai = 0;

    for (let i = 1; i < data.length; i++) {
        tunai += Number(data[i][3]) || 0;
        nonTunai += Number(data[i][4]) || 0;
    }

    return {
        tunai: tunai,
        nonTunai: nonTunai,
        total: tunai + nonTunai
    };
}

// Dashboard over a date range
function getDashboardRange(startDate, endDate) {
    const transaksiSheet = initSheet("transaksi");
    const data = transaksiSheet.getDataRange().getValues();

    const start = new Date(startDate + "T00:00:00");
    const end = new Date(endDate + "T23:59:59");

    let pemasukan = 0;
    let pengeluaran = 0;
    let tunaiIn = 0, tunaiOut = 0, nonTunaiIn = 0, nonTunaiOut = 0;
    let count = 0;
    let sumTransaksi = 0;

    const recent = [];

    for (let i = 1; i < data.length; i++) {
        const tgl = data[i][0];
        const ket = data[i][1];
        const kat = data[i][2];
        const tunai = Number(data[i][3]) || 0;
        const nonTunai = Number(data[i][4]) || 0;

        let tglObj = tgl instanceof Date && !isNaN(tgl) ? tgl : new Date(tgl);
        if (!(tglObj >= start && tglObj <= end)) continue;

        const totalBaris = tunai + nonTunai;
        if (kat === 'Pemasukan') {
            pemasukan += totalBaris;
            tunaiIn += tunai;
            nonTunaiIn += nonTunai;
        } else if (kat === 'Pengeluaran') {
            pengeluaran += totalBaris;
            tunaiOut += tunai;
            nonTunaiOut += nonTunai;
        }
        count += 1;
        sumTransaksi += totalBaris;

        recent.push([
            Utilities.formatDate(tglObj, Session.getScriptTimeZone(), "yyyy-MM-dd"),
            ket, kat, tunai, nonTunai
        ]);
    }

    // sort recent by date desc using original order by scanning backwards is simpler
    recent.sort((a, b) => (a[0] < b[0] ? 1 : a[0] > b[0] ? -1 : 0));
    // If startDate is sentinel (all), return all recents; else limit to 10
    const recentOutput = (startDate === '2000-01-01') ? recent : recent.slice(0, 10);

    const kasTotal = tunaiIn - tunaiOut;
    const nonKasTotal = nonTunaiIn - nonTunaiOut;

    // Low stock (top 5 ascending)
    const stokSheet = initSheet("stok");
    const stokValues = stokSheet.getLastRow() > 1 ? stokSheet.getRange(2, 1, stokSheet.getLastRow() - 1, 2).getValues() : [];
    stokValues.sort((a, b) => (Number(a[1]) || 0) - (Number(b[1]) || 0));
    const lowStock = stokValues.slice(0, 5);

    return {
        kpi: {
            pemasukan: pemasukan,
            pengeluaran: pengeluaran,
            labaBersih: pemasukan - pengeluaran,
            jumlahTransaksi: count,
            rataRataTransaksi: count ? Math.round(sumTransaksi / count) : 0,
            kas: kasTotal,
            nonKas: nonKasTotal
        },
        recent: recentOutput,
        lowStock: lowStock
    };
}


// Edit transaksi berdasarkan index (dihitung dari bawah)
function editTransaksi(data) {
    const sheet = initSheet("transaksi");
    const lastRow = sheet.getLastRow();
    const row = lastRow - data.rowIndex; // karena kita reverse di frontend

    sheet.getRange(row, 1, 1, 5).setValues([[data.tgl, data.ket, data.kat, data.tunai, data.nonTunai]]);
}

// Hapus transaksi
function deleteTransaksi(index) {
    const sheet = initSheet("transaksi");
    const lastRow = sheet.getLastRow();
    const row = lastRow - index;
    
    // Ensure we don't delete header row
    if (row > 1) {
        sheet.deleteRow(row);
    }
}


// === TRANSAKSI ===
// Ambil semua transaksi
function getTransaksi() {
    const sheet = initSheet("transaksi");
    const lastRow = sheet.getLastRow();
    const lastCol = sheet.getLastColumn();

    if (lastRow <= 1) return [];

    const values = sheet.getRange(2, 1, lastRow - 1, lastCol).getValues();
    return values.filter(row => row.some(cell => cell !== null && cell !== ''));
}



// 10 transaksi terakhir
function getLast10Transaksi() {
    const all = getTransaksi();
    const last10 = all.slice(-10).reverse();
    return last10;
}



function addTransaksi(data) {
    const sheet = initSheet("transaksi");
    sheet.appendRow([data.tgl, data.ket, data.kat, data.tunai, data.nonTunai]);
}

// === PRODUK ===
function getProduk() {
    const sheet = initSheet("produk");
    const values = sheet.getRange(2, 1, sheet.getLastRow() - 1, 3).getValues();
    return values.map(row => Array.from(row));
}

function addProduk(id, nama, harga) {
    const sheet = initSheet("produk");
    sheet.appendRow([id, nama, harga]);
}

// === STOK ===
function getStok() {
    const sheet = initSheet("stok");
    const values = sheet.getRange(2, 1, sheet.getLastRow() - 1, 2).getValues();
    return values.map(row => Array.from(row));
}

function addStok(id, jumlah) {
    const sheet = initSheet("stok");
    sheet.appendRow([id, jumlah]);
}

// === LAPORAN ===
function getLaporan(startDate, endDate) {
    const sheet = initSheet("transaksi");
    const data = sheet.getDataRange().getValues();

    let result = [];
    let totalTunai = 0, totalNonTunai = 0;

    // pastikan range tanggal
    const start = new Date(startDate + "T00:00:00");
    const end = new Date(endDate + "T23:59:59");

    for (let i = 1; i < data.length; i++) {
        let tgl = data[i][0];
        let ket = data[i][1];
        let kat = data[i][2];
        let tunai = Number(data[i][3]) || 0;
        let nonTunai = Number(data[i][4]) || 0;

        // normalisasi tanggal (Google Sheets bisa simpan Date object atau string)
        let tglObj;
        if (Object.prototype.toString.call(tgl) === "[object Date]" && !isNaN(tgl)) {
            tglObj = tgl; // sudah Date
        } else {
            tglObj = new Date(tgl);
        }

        if (tglObj >= start && tglObj <= end) {
            result.push([
                Utilities.formatDate(tglObj, Session.getScriptTimeZone(), "dd/MM/yyyy"),
                ket,
                kat,
                tunai,
                nonTunai
            ]);
            totalTunai += tunai;
            totalNonTunai += nonTunai;
        }
    }

    return {
        data: result,
        totalTunai: totalTunai,
        totalNonTunai: totalNonTunai,
        total: totalTunai + totalNonTunai
    };
}

// Export Laporan helpers
function buildLaporanSheet_(startDate, endDate) {
    const laporan = getLaporan(startDate, endDate);
    const ss = SpreadsheetApp.create(`Laporan ${startDate} s.d. ${endDate}`);
    const sh = ss.getActiveSheet();
    sh.setName('Laporan');

    // Title
    const title = `Laporan Kas Kedai Nongki (${startDate} s.d. ${endDate})`;
    sh.getRange(1, 1).setValue(title);
    sh.getRange(1, 1, 1, 5).merge();
    sh.getRange(1, 1).setFontSize(14).setFontWeight('bold').setHorizontalAlignment('center');

    // Header
    const headers = [["Tanggal", "Keterangan", "Kategori", "Tunai", "Non Tunai"]];
    sh.getRange(2, 1, 1, headers[0].length)
        .setValues(headers)
        .setFontWeight('bold')
        .setHorizontalAlignment('center')
        .setBackground('#f0f0f0');

    // Data
    if (laporan.data.length > 0) {
        sh.getRange(3, 1, laporan.data.length, 5).setValues(laporan.data);
        // Formats
        sh.getRange(3, 1, laporan.data.length, 1).setNumberFormat("dd/MM/yyyy");
        sh.getRange(3, 4, Math.max(1, laporan.data.length), 2).setNumberFormat("[$Rp-421] #,##0");
        sh.getRange(3, 1, laporan.data.length, 5).setWrap(false);
        // Borders
        const tableRange = sh.getRange(2, 1, laporan.data.length + 1, 5);
        tableRange.setBorder(true, true, true, true, true, true, '#cccccc', SpreadsheetApp.BorderStyle.SOLID);

        // Totals block
        const last = laporan.data.length + 3;
        sh.getRange(last, 1, 3, 5).setValues([
            ["", "", "Total Tunai", laporan.totalTunai, ""],
            ["", "", "Total Non Tunai", "", laporan.totalNonTunai],
            ["", "", "Total", laporan.totalTunai + laporan.totalNonTunai, ""]
        ]).setFontWeight('bold');
        sh.getRange(last, 4, 3, 2).setNumberFormat("[$Rp-421] #,##0");
    } else {
        // Empty state nicely
        sh.getRange(3, 1).setValue('Tidak ada data pada rentang tanggal ini').setItalic(true);
        sh.getRange(3, 1, 1, 5).merge();
    }

    // Alignments
    sh.getRange(3, 2, Math.max(1, laporan.data.length), 2).setHorizontalAlignment('left');
    sh.getRange(3, 4, Math.max(1, laporan.data.length), 2).setHorizontalAlignment('right');

    // Freeze header row
    sh.setFrozenRows(2);

    // Column widths
    sh.autoResizeColumns(1, 5);
    sh.setColumnWidths(1, 1, 110);
    sh.setColumnWidths(2, 1, 220);

    return ss;
}

function exportLaporanPDF(startDate, endDate) {
    const ss = buildLaporanSheet_(startDate, endDate);
    const sheet = ss.getActiveSheet();
    SpreadsheetApp.flush();

    const exportUrl = `https://docs.google.com/spreadsheets/d/${ss.getId()}/export?` +
        `format=pdf&` +
        `portrait=true&` +
        `scale=2&` + // fit to width
        `size=A4&` +
        `sheetnames=false&` +
        `printtitle=false&` +
        `pagenumbers=true&` +
        `gridlines=false&` +
        `fzr=true&` +
        `top_margin=0.5&bottom_margin=0.5&left_margin=0.5&right_margin=0.5&` +
        `horizontal_alignment=CENTER&` +
        `gid=${sheet.getSheetId()}`;

    const token = ScriptApp.getOAuthToken();
    const resp = UrlFetchApp.fetch(exportUrl, { headers: { Authorization: `Bearer ${token}` } });
    const blob = resp.getBlob().setName(ss.getName() + '.pdf');

    const pdfFile = DriveApp.createFile(blob);
    DriveApp.getFileById(ss.getId()).setTrashed(true);
    return { url: pdfFile.getUrl(), fileId: pdfFile.getId() };
}

// Return PDF as base64 for direct download in browser
function exportLaporanPDFInline(startDate, endDate) {
    const ss = buildLaporanSheet_(startDate, endDate);
    const sheet = ss.getActiveSheet();
    SpreadsheetApp.flush();

    const exportUrl = `https://docs.google.com/spreadsheets/d/${ss.getId()}/export?` +
        `format=pdf&portrait=true&scale=2&size=A4&sheetnames=false&printtitle=false&` +
        `pagenumbers=false&gridlines=true&fzr=false&gid=${sheet.getSheetId()}`;

    const token = ScriptApp.getOAuthToken();
    const resp = UrlFetchApp.fetch(exportUrl, { headers: { Authorization: `Bearer ${token}` } });
    const blob = resp.getBlob().setName(ss.getName() + '.pdf');
    const base64 = Utilities.base64Encode(blob.getBytes());

    DriveApp.getFileById(ss.getId()).setTrashed(true);
    return { filename: ss.getName() + '.pdf', mime: 'application/pdf', base64: base64 };
}

function exportLaporanExcel(startDate, endDate) {
    const ss = buildLaporanSheet_(startDate, endDate);
    SpreadsheetApp.flush();
    const blob = DriveApp.getFileById(ss.getId()).getAs(MimeType.MICROSOFT_EXCEL);
    const xlsx = DriveApp.createFile(blob).setName(ss.getName() + '.xlsx');
    DriveApp.getFileById(ss.getId()).setTrashed(true);
    return { url: xlsx.getUrl(), fileId: xlsx.getId() };
}
